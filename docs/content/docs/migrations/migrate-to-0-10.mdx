---
title: Migrate to 0.10
description: Migrate to @convex-dev/better-auth@0.10
---

## Upgrade component

<div className="fd-steps">

  <div className="fd-step">
    ### Install dependencies

    Update Better Auth and the component.

    <Callout>
      Be sure to review [breaking changes in Better Auth 1.4](https://www.better-auth.com/blog/1-4#%EF%B8%8F-breaking-changes).
    </Callout>

    <Callout>
      Check your dependencies for Better Auth packages and be sure to pin them all to 1.4.7. For example if you're using @better-auth/expo, it would also need to be upgraded.
    </Callout>

    ```npm
    npm install @convex-dev/better-auth@^0.10.0
    npm install better-auth@1.4.7 --save-exact
    ```

  </div>

</div>

## Update auth config

<div className="fd-steps">

  <div className="fd-step">

### Use `customJwt` auth config

[`customJwt` auth config](https://docs.convex.dev/auth/advanced/custom-jwt) is
now recommended for faster JWT validation. A helper is provided to generate the
config object.

```ts title="convex/auth.config.ts"
import type { AuthConfig } from "convex/server";
import { getAuthConfigProvider } from "@convex-dev/better-auth/auth-config";

export default {
  providers: [
    getAuthConfigProvider(), // [!code ++]
    // [!code --:4]
    {
      applicationID: "convex",
      domain: process.env.CONVEX_SITE_URL!,
    },
  ],
} satisfies AuthConfig;
```

</div>

  <div className="fd-step">

### Update Convex Better Auth plugin config

The Convex Better Auth plugin now requires the auth config object. This helps
minimize configuration and ensure accuracy.

Additionally, as this new configuration uses RS256 instead of EdDSA (for
compatibility with `customJwt`), you'll want to set
`jwksRotateOnTokenGenerationError` to `true` initially so keys can be rotated
when algorithm mismatch occurs. This can be disabled later if desired.

```ts title="convex/auth.ts"
import authConfig from "./auth.config";

export const createAuthOptions = (ctx: GenericCtx<DataModel>) => {
  return {
    baseURL: siteUrl,
    database: authComponent.adapter(ctx),
    // ... other auth config
    plugins: [
      // ... other plugins
      convex(), // [!code --]
      // [!code ++:4]
      convex({
        authConfig,
        jwksRotateOnTokenGenerationError: true,
      }),
    ],
  } satisfies BetterAuthOptions;
};
```

</div>

<div className="fd-step">

### Drop `optionsOnly` parameter from `createAuth`

The `optionsOnly` parameter is no longer needed.

```ts title="convex/auth.ts"
// [!code --:4]
export const createAuth = (
  ctx: GenericCtx<DataModel>,
  { optionsOnly } = { optionsOnly: false },
) => {
export const createAuth = (ctx: GenericCtx<DataModel>) => { // [!code ++]
  return betterAuth({
    // [!code --:3]
    logger: {
      disabled: optionsOnly,
    },
    // ... auth config
  });
}
```

</div>

</div>

## SSR improvements

The following steps are only necessary for apps using SSR (eg., Next.js,
TanStack Start).

<div className="fd-steps">
<div className="fd-step">

### Update framework server utilities

Server utilities are provided for TanStack Start and Next.js to provide the same
kind of set-it-and-forget-it auth management that you get in the client, on the
server.

The configuration requires explicit URLs for Convex with runtime validation,
which should reduce environment variable confusion.

Replace usage of previous versions of these functions with the new ones, eg.,
`preloadQuery` with `preloadAuthQuery`, `fetchQuery` with `fetchAuthQuery`, etc.
Note that the new functions only accept a function reference and arguments, a
third option with configuration such as a token is not accepted or required.

<Tabs groupId="framework" items={["next-js", "tanstack-start"]} defaultValue="next-js" persist>
<Tab value="next-js">

```ts title="lib/auth-server.ts"
import { createAuth } from "@/convex/auth"; // [!code --]
import { getToken as getTokenNextjs } from "@convex-dev/better-auth/nextjs"; // [!code --]
import { convexBetterAuthNextJs } from "@convex-dev/better-auth/nextjs"; // [!code ++]

// [!code --:3]
export const getToken = () => {
  return getTokenNextjs(createAuth);
};

// [!code ++:12]
export const {
  handler,
  preloadAuthQuery,
  isAuthenticated,
  getToken,
  fetchAuthQuery,
  fetchAuthMutation,
  fetchAuthAction,
} = convexBetterAuthNextJs({
  convexUrl: process.env.NEXT_PUBLIC_CONVEX_URL!,
  convexSiteUrl: process.env.NEXT_PUBLIC_CONVEX_SITE_URL!,
});
```

</Tab>

<Tab value="tanstack-start">

```ts title="src/lib/auth-server.ts"
// [!code --:3]
import { createAuth } from "convex/auth";
import { setupFetchClient } from "@convex-dev/better-auth/react-start";
import { getCookie } from "@tanstack/react-start/server";
import { convexBetterAuthReactStart } from "@convex-dev/better-auth/react-start"; // [!code ++]

// [!code --:2]
export const { fetchQuery, fetchMutation, fetchAction } =
  await setupFetchClient(createAuth, getCookie);

// [!code ++:10]
export const {
  handler,
  getToken,
  fetchAuthQuery,
  fetchAuthMutation,
  fetchAuthAction,
} = convexBetterAuthReactStart({
  convexUrl: process.env.VITE_CONVEX_URL!,
  convexSiteUrl: process.env.VITE_CONVEX_SITE_URL!,
});
```

</Tab>
</Tabs>

</div>

<div className="fd-step">

### Update route handlers

Update your route handlers to use the new handler.

<Tabs groupId="framework" items={["next-js", "tanstack-start"]} defaultValue="next-js" persist>
<Tab value="next-js">
```ts title="app/api/auth/[...all]/route.ts"
import { nextJsHandler } from "@convex-dev/better-auth/nextjs"; // [!code --]
import { handler } from "@/lib/auth-server"; // [!code ++]

export const { GET, POST } = nextJsHandler(); // [!code --]
export const { GET, POST } = handler; // [!code ++]
```
</Tab>

<Tab value="tanstack-start">
```ts title="src/routes/api/auth/$.ts"
import { createFileRoute } from '@tanstack/react-router'
import { reactStartHandler } from '@convex-dev/better-auth/react-start' // [!code --]
import { handler } from '~/lib/auth-server' // [!code ++]

export const Route = createFileRoute('/api/auth/$')({
  server: {
    handlers: {
      // [!code --:2]
      GET: ({ request }) => reactStartHandler(request),
      POST: ({ request }) => reactStartHandler(request),
      // [!code ++:2]
      GET: ({ request }) => handler(request),
      POST: ({ request }) => handler(request),
    },
  },
})
```
</Tab>
</Tabs>
</div>

<div className="fd-step">

### Pass initial token to ConvexBetterAuthProvider

Apps using Next.js or TanStack Start can pass the an initial token to speed up
client authentication.

<Tabs groupId="framework" items={["next-js", "tanstack-start"]} defaultValue="next-js" persist>
<Tab value="next-js">

Update your `ConvexClientProvider` to accept an initial token.

```tsx title="app/ConvexClientProvider.tsx"
export function ConvexClientProvider({
  children,
  initialToken, // [!code ++]
}: {
  children: ReactNode;
  initialToken?: string | null; // [!code ++]
}) {
  return (
    <ConvexBetterAuthProvider
      client={convex}
      authClient={authClient}
      initialToken={initialToken} // [!code ++]
    >
      {children}
    </ConvexBetterAuthProvider>
  );
}
```

Then fetch the initial token on the server from your root layout and pass it to
the `ConvexClientProvider`.

```tsx title="app/layout.tsx"
import { getToken } from "@/lib/auth-server"; // [!code ++]
import { ConvexClientProvider } from "./ConvexClientProvider";
import { PropsWithChildren } from "react";

export default async function RootLayout({ children }: PropsWithChildren) {
  const token = await getToken(); // [!code ++]
  return (
    <html>
      <body>
        {/* [!code --] */}
        <ConvexClientProvider>
        {/* [!code ++] */}
        <ConvexClientProvider initialToken={token}>
          {children}
        </ConvexClientProvider>
      </body>
    </html>
  );
}
```

</Tab>
<Tab value="tanstack-start">
```tsx title="src/routes/__root.tsx"
function RootComponent() {
  const context = useRouteContext({ from: Route.id })
  return (
    <ConvexBetterAuthProvider
      client={context.convexQueryClient.convexClient}
      authClient={authClient}
      initialToken={context.token} // [!code ++]
    >
      <RootDocument>
        <Outlet />
      </RootDocument>
    </ConvexBetterAuthProvider>
  )
}
```
</Tab>
</Tabs>
</div>
</div>

## Next.js changes

<div className="fd-steps">
<div className="fd-step">
#### Use `useAuthPreloadedQuery`

`usePreloadedAuthQuery` replaces `usePreloadedQuery` as a drop-in - it ensures
server rendered data is rendered until authentication is ready.

```tsx title="app/(auth)/(dashboard)/todo-list.tsx"
import { useAuthPreloadedQuery } from "@convex-dev/better-auth/nextjs/client";

export const TodoList = ({ preloadedUserQuery }) => {
  const userQuery = useAuthPreloadedQuery(preloadedUserQuery);
  return (
    <div>
      <h1>{userQuery?.name}</h1>
    </div>
  );
};
```

</div>
</div>

## TanStack Start changes

<div className="fd-steps">

<div className="fd-step">
  ### Update Vite configuration

Update Vite configuration to bundle `@convex-dev/better-auth` during SSR to
avoid module resolution issues.

```ts title="vite.config.ts"
export default defineConfig({
  // ...other config
  ssr: {
    noExternal: ["@convex-dev/better-auth"],
  },
});
```

</div>

<div className="fd-step">
### Update router config

Update the router to set `expectAuth: true` on the ConvexQueryClient - without
this, authenticated data from server render is lost immediately after first
render.

Also drop the unused `Wrap` provider (if you have one).

```tsx title="src/router.tsx"
export function getRouter() {
  const convexUrl = (import.meta as any).env.VITE_CONVEX_URL!;
  if (!convexUrl) {
    throw new Error("VITE_CONVEX_URL is not set");
  }
  const convexQueryClient = new ConvexQueryClient(convexUrl, {
    expectAuth: true, // [!code ++]
  });

  const queryClient: QueryClient = new QueryClient({
    defaultOptions: {
      queries: {
        queryKeyHashFn: convexQueryClient.hashFn(),
        queryFn: convexQueryClient.queryFn(),
      },
    },
  });
  convexQueryClient.connect(queryClient);

  const router = createTanStackRouter({
    routeTree,
    defaultPreload: "intent",
    defaultErrorComponent: DefaultCatchBoundary,
    defaultNotFoundComponent: () => <NotFound />,
    // [!code --:5]
    Wrap: ({ children }) => (
      <ConvexProvider client={convexQueryClient.convexClient}>
        {children}
      </ConvexProvider>
    ),
    context: { queryClient, convexQueryClient },
    scrollRestoration: true,
  });
  setupRouterSsrQueryIntegration({
    router,
    queryClient,
  });

  return router;
}
```

</div>

<div className="fd-step">

### Update root route

Update the root route to use the new `getAuth()` server function and
`isAuthenticated` context value.

```tsx title="src/routes/__root.tsx"
import { createServerFn } from "@tanstack/react-start";
// [!code --:4]
import {
  fetchSession,
  getCookieName,
} from "@convex-dev/better-auth/react-start";
import { getCookie, getRequest } from "@tanstack/react-start/server"; // [!code --]
import { getToken } from "@/lib/auth-server"; // [!code ++]

// [!code --:10]
const fetchAuth = createServerFn({ method: "GET" }).handler(async () => {
  const { createAuth } = await import("@convex/auth");
  const { session } = await fetchSession(getRequest());
  const sessionCookieName = getCookieName(createAuth);
  const token = getCookie(sessionCookieName);
  return {
    userId: session?.user.id,
    token,
  };
});

// [!code ++:3]
const getAuth = createServerFn({ method: "GET" }).handler(async () => {
  return await getToken();
});

export const Route = createRootRouteWithContext<{
  queryClient: QueryClient;
  convexQueryClient: ConvexQueryClient;
}>()({
  // ... other config
  beforeLoad: async (ctx) => {
    const token = await getAuth();

    // all queries, mutations and actions through TanStack Query will be
    // authenticated during SSR if we have a valid token
    if (token) {
      // During SSR only (the only time serverHttpClient exists),
      // set the auth token to make HTTP queries with.
      ctx.context.convexQueryClient.serverHttpClient?.setAuth(token);
    }

    return {
      isAuthenticated: !!token,
      token,
    };
  },
  component: RootComponent,
});
```

</div>

<div className="fd-step">

### Reload on sign out

Finally, update your signOut function(s) to reload the page. This allows
`expectAuth` to work correctly for the next sign in. For apps with authenticated
routes, signing out can typically replace a redirect.

```ts title="src/lib/auth-client.ts"
export const handleSignOut = async () => {
  const navigate = useNavigate();
  await authClient.signOut({
    fetchOptions: {
      onSuccess: () => {
        navigate({ to: "/" }); // [!code --]
        location.reload(); // [!code ++]
      },
    },
  });
};
```

</div>

</div>

## Local Install additional steps

The following steps are only necessary for apps using
[Local Install](/local-install).

<div className="fd-steps">

  <div className="fd-step">

### Remove `getStaticAuth`

Remove `getStaticAuth` in `convex/betterAuth/auth.ts` and replace it with a
simple `createAuth`

```ts title="convex/betterAuth/auth.ts"
import { getStaticAuth } from "@convex-dev/better-auth"; // [!code --]
import { v } from "convex/values";
import { createAuth } from "../auth";

// Export a static instance for Better Auth schema generation
export const auth = getStaticAuth(createAuth); // [!code --]
export const auth = createAuth({} as any); // [!code ++]
```

  </div>

  <div className="fd-step">

### Regenerate schema

Whenever updating Better Auth w/ Local Install, regenerate the schema.

```npm
cd convex/betterAuth
npx @better-auth/cli generate -y
```

</div>

<div className="fd-step">

### Split out `createAuthOptions` function

The previous approach of configuring Better Auth options inside of the
`betterAuth()` function call meant we had to run Better Auth to access options
statically. This led to unnecessary logging and inaccurate error messages, and
required workarounds like using `optionsOnly` to disable logging.

To avoid all of this moving forward, you'll want to have a separate
`createAuthOptions` function that just returns the typed options object.

```ts title="convex/auth.ts"
import {
  betterAuth,
  type BetterAuthOptions, // [!code ++]
} from "better-auth";

// [!code ++:5]
export const createAuthOptions = (ctx: GenericCtx<DataModel>) => {
  return {
    // ... auth config
  } satisfies BetterAuthOptions;
};

export const createAuth = (ctx: GenericCtx<DataModel>) => {
  // [!code --:3]
  return betterAuth({
    // ... auth config
  });
  return betterAuth(createAuthOptions(ctx)); // [!code ++]
};
```

</div>

<div className="fd-step">
### Update adapter

Replace usage of `createAuth` with `createAuthOptions` in `adapter.ts`.

You'll also drop the removed `migrationRemoveUserId` function.

```ts title="convex/betterAuth/adapter.ts"
import { createApi } from "@convex-dev/better-auth";
import {
  createAuth, // [!code --]
  createAuthOptions, // [!code ++]
} from "./auth";
import schema from "./schema";

export const {
  create,
  findOne,
  findMany,
  updateOne,
  updateMany,
  deleteOne,
  deleteMany,
  migrationRemoveUserId, // [!code --]
} = createApi(schema, createAuth); // [!code --]
} = createApi(schema, createAuthOptions); // [!code ++]
```

</div>

</div>
