---
title: App user id in component table
description: Configure Better Auth to continue tracking app user id in component table
---

<Callout>
  This guide shows one of two recommended strategies for migrating away from
  maintaining a `user.userId` field in the Better Auth user table. Read [the
  overview](/migrations/migrate-userid) for more information.
</Callout>

This guide is for configuring Better Auth to continue the existing behavior of
tracking the app user id in the component table.

<div className="fd-steps">

<div className="fd-step">

### Run convex dev

Keep the Convex dev server running while following the migration steps.

```npm
npx convex dev
```

</div>

<div className="fd-step">

### Migrate to Local Install

If you haven't already, follow the guide to migrate to [Local Install](/local-install).

</div>

<div className="fd-step">
### Add userId field to component schema

Use Better Auth's
[`additionalFields`](https://www.better-auth.com/docs/concepts/database#extending-core-schema)
option to add the `userId` field to the component schema.

```ts title="convex/auth.ts"
export const createAuth = (
  ctx: GenericCtx<DataModel>,
  { optionsOnly } = { optionsOnly: false }
) => {
  return betterAuth({
    // [!code ++:8]
    user: {
      additionalFields: {
        userId: {
          type: "string",
          required: false,
        },
      },
    },
  });
};
```

</div>

<div className="fd-step">

### Regenerate schema

Regenerate the Better Auth schema to include the new `userId` field.

```npm
cd convex/betterAuth && npx @better-auth/cli generate -y
```

</div>

<div className="fd-step">

### Add `setUserId` mutation

The component has a deprecated `setUserId` method, you'll want to create your
own to replace it.

```ts title="convex/betterAuth/auth.ts"
export const setUserId = mutation({
  args: {
    authId: v.id("user"),
    userId: v.string(),
  },
  handler: async (ctx, args) => {
    await ctx.db.patch(args.authId, {
      userId: args.userId,
    });
  },
});
```

</div>

<div className="fd-step">

### Update user onCreate trigger

Update the user onCreate trigger to set the `userId` field on the Better Auth user.

```ts title="convex/auth.ts"
export const authComponent = createClient<DataModel, typeof betterAuthSchema>(
  components.betterAuth,
  {
    authFunctions,
    local: {
      schema: betterAuthSchema,
    },
    triggers: {
      user: {
        onCreate: async (ctx, authUser) => {
          const userId = await ctx.db.insert("users", {
            email: authUser.email,
          });
          await authComponent.setUserId(ctx, authUser._id, userId); // [!code --]
          // [!code ++:4]
          await ctx.runMutation(components.betterAuth.auth.setUserId, {
            authId: authUser._id,
            userId,
          });
        },
      },
    },
  }
);
```

</div>

<div className="fd-step">
### All set ðŸŽ‰

Previous behavior is now configured manually, no changes in behavior should result.

</div>
</div>
